name: "Release"

on: workflow_dispatch

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tauri.conf.json
        id: get-version
        shell: bash
        run: |
          VERSION=$(grep -o '"version": "[^"]*"' src-tauri/tauri.conf.json | cut -d'"' -f4)
          echo "Application version from tauri.conf.json: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create Draft Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.get-version.outputs.version }}';
            const body = [
              '## AVX2 Optimized Build',
              '',
              '**This is the AVX2-optimized version of AivoRelay.**',
              '',
              '### Recommended for most users',
              'If your computer was made after 2013, use this version for **2-3x faster** speech recognition.',
              '',
              '### Requirements',
              '- Intel: 4th generation (Haswell) or newer',
              '- AMD: Ryzen or newer',
              '',
              '### Not sure?',
              'Try this version first. If your CPU doesn\'t support AVX2, the app will show an error on startup - then download the standard version instead.',
              '',
              '---',
              '*For older CPUs without AVX2 support, see the [standard release](https://github.com/MaxITService/AIVORelay/releases).*'
            ].join('\n');

            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}-avx2`,
              name: `v${version} (AVX2)`,
              body: body,
              draft: true,
              prerelease: false,
              generate_release_notes: true
            })
            return data.id

  publish-tauri:
    permissions:
      contents: write
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: ""
            target: "x86_64-pc-windows-msvc"

    uses: ./.github/workflows/build.yml
    with:
      platform: ${{ matrix.platform }}
      target: ${{ matrix.target }}
      build-args: ${{ matrix.args }}
      sign-binaries: true
      asset-prefix: "aivorelay-avx2"
      upload-artifacts: false
      release-id: ${{ needs.create-release.outputs.release-id }}
    secrets: inherit
